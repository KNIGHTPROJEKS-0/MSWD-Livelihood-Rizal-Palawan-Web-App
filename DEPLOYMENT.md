# üöÄ MSWD Deployment Guide

## üìã Overview

This guide covers deployment strategies for the MSWD Livelihood Rizal Palawan Web Application across different environments and platforms.

## üèóÔ∏è Deployment Architecture

### Production Stack
- **Frontend**: React app served via CDN
- **Backend**: FastAPI on containerized infrastructure
- **Database**: PostgreSQL with automated backups
- **Cache**: Redis for session management
- **Storage**: Firebase Storage for file uploads
- **Monitoring**: Health checks and logging
- **Automation**: n8n workflows for business processes

## üöÇ Railway Deployment (Recommended)

### Prerequisites
```bash
# Install Railway CLI
npm install -g @railway/cli

# Verify installation
railway --version
```

### Project Information
- **Railway Project ID**: `112eaa22-255c-4f61-9e19-fa30afa29e04`
- **Railway Token**: `bda800d1-dccb-4fb5-8c21-95e4936cf40c`

### Quick Deployment
```bash
# Set Railway token
export RAILWAY_TOKEN=bda800d1-dccb-4fb5-8c21-95e4936cf40c

# Deploy using script
./deploy-railway.sh
```

### Manual Railway Setup

#### 1. Authentication
```bash
# Login to Railway
railway login

# Link to existing project
railway link -p 112eaa22-255c-4f61-9e19-fa30afa29e04
```

#### 2. Deploy Services
```bash
# Deploy API service
cd services/api
railway up --service api

# Deploy Frontend
cd apps/web
railway up --service frontend
```

#### 3. Add Database Services
```bash
# Add PostgreSQL
railway add postgresql

# Add Redis
railway add redis

# Add n8n (optional)
railway add n8n
```

#### 4. Configure Environment Variables
```bash
# Essential variables
railway variables set SECRET_KEY="$(openssl rand -hex 32)"
railway variables set ALGORITHM="HS256"
railway variables set ACCESS_TOKEN_EXPIRE_MINUTES="30"
railway variables set ENVIRONMENT="production"
railway variables set PROJECT_NAME="MSWD Livelihood Rizal Palawan"

# Database URLs (auto-generated by Railway)
railway variables set DATABASE_URL="$RAILWAY_POSTGRESQL_URL"
railway variables set REDIS_URL="$RAILWAY_REDIS_URL"

# Firebase configuration
railway variables set VITE_FIREBASE_API_KEY="your-api-key"
railway variables set VITE_FIREBASE_AUTH_DOMAIN="your-domain"
railway variables set VITE_FIREBASE_PROJECT_ID="your-project-id"

# CORS configuration
railway variables set BACKEND_CORS_ORIGINS='["https://your-frontend-domain.railway.app"]'
```

### Service URLs
After deployment, services will be available at:
- **API**: `https://mswd-api-production.railway.app`
- **Frontend**: `https://mswd-frontend-production.railway.app`
- **n8n**: `https://mswd-n8n-production.railway.app`

## üéØ Render Deployment

### Configuration
Render deployment is configured via `infra/render.yaml`:

```yaml
services:
  - type: web
    name: mswd-api
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    
  - type: web
    name: mswd-frontend
    env: node
    buildCommand: pnpm install && pnpm run build
    startCommand: pnpm run preview
```

### Deployment Steps
```bash
# Connect to Render
# 1. Go to render.com
# 2. Connect GitHub repository
# 3. Use render.yaml for configuration
# 4. Set environment variables in Render dashboard
```

## üåê Platform.sh Deployment

### Configuration
Platform.sh deployment uses `infra/platform.app.yaml`:

```yaml
name: mswd-app
type: python:3.11

web:
  commands:
    start: uvicorn app.main:app --host 0.0.0.0 --port $PORT

disk: 1024

mounts:
  '/tmp': 'shared:files/tmp'
```

### Deployment Steps
```bash
# Install Platform.sh CLI
curl -sS https://platform.sh/cli/installer | php

# Deploy
platform deploy
```

## üê≥ Docker Deployment

### Build Images
```bash
# Build API image
cd services/api
docker build -t mswd-api .

# Build frontend image
cd apps/web
docker build -t mswd-frontend .
```

### Docker Compose Production
```yaml
version: '3.8'
services:
  api:
    image: mswd-api
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/mswd
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  frontend:
    image: mswd-frontend
    ports:
      - "3000:3000"
    depends_on:
      - api

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: mswd
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### Deploy with Docker
```bash
# Start production stack
docker-compose -f docker-compose.prod.yml up -d

# View logs
docker-compose logs -f

# Scale services
docker-compose up -d --scale api=3
```

## üîÑ CI/CD Pipeline

### GitHub Actions
The project includes automated deployment via `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Railway
        run: |
          npm install -g @railway/cli
          railway deploy --service api
          railway deploy --service frontend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

### Required Secrets
Add these to GitHub repository secrets:
```bash
RAILWAY_TOKEN=bda800d1-dccb-4fb5-8c21-95e4936cf40c
RAILWAY_PROJECT_ID=112eaa22-255c-4f61-9e19-fa30afa29e04
```

## üîê Environment Variables

### Production Environment Variables
```bash
# Application
SECRET_KEY=your-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
ENVIRONMENT=production
PROJECT_NAME=MSWD Livelihood Rizal Palawan
PROJECT_VERSION=1.0.0
API_V1_STR=/api/v1

# Database
DATABASE_URL=postgresql://user:pass@host:port/db
REDIS_URL=redis://host:port/db

# Firebase
VITE_FIREBASE_API_KEY=your-api-key
VITE_FIREBASE_AUTH_DOMAIN=your-domain
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_STORAGE_BUCKET=your-bucket
VITE_FIREBASE_MESSAGING_SENDER_ID=your-sender-id
VITE_FIREBASE_APP_ID=your-app-id

# CORS
BACKEND_CORS_ORIGINS=["https://your-frontend-domain.com"]

# Email (optional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# n8n (optional)
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=secure-password
WEBHOOK_URL=https://your-n8n-domain.com
GENERIC_TIMEZONE=Asia/Manila
```

## üìä Health Checks & Monitoring

### API Health Endpoints
```bash
# Basic health check
curl https://your-api-domain.com/health

# Detailed health check
curl https://your-api-domain.com/health/detailed

# Database connectivity
curl https://your-api-domain.com/health/db
```

### Monitoring Setup
```bash
# Set up monitoring endpoints
# - /health - Basic health status
# - /metrics - Prometheus metrics
# - /logs - Application logs

# Configure alerts for:
# - API response time > 2s
# - Database connection failures
# - High error rates (>5%)
# - Memory usage > 80%
```

## üîÑ n8n Workflow Integration

### n8n Setup
```bash
# Deploy n8n service
railway add n8n

# Configure n8n environment
railway variables set N8N_BASIC_AUTH_ACTIVE=true
railway variables set N8N_BASIC_AUTH_USER=admin
railway variables set N8N_BASIC_AUTH_PASSWORD=secure-password
```

### Workflow Configuration
1. **Application Processing Workflow**
   - Trigger: Webhook from API
   - Actions: Email notifications, status updates
   
2. **Beneficiary Management Workflow**
   - Trigger: Status change events
   - Actions: Notifications, reporting
   
3. **Program Monitoring Workflow**
   - Trigger: Scheduled (daily/weekly)
   - Actions: Reports, deadline reminders

## üóÑÔ∏è Database Management

### Production Database Setup
```bash
# Create production database
createdb mswd_production

# Run migrations
cd services/api
alembic upgrade head

# Create initial admin user
python scripts/create_admin.py
```

### Backup Strategy
```bash
# Automated daily backups
pg_dump mswd_production > backup_$(date +%Y%m%d).sql

# Restore from backup
psql mswd_production < backup_20250115.sql

# Point-in-time recovery setup
# Configure WAL archiving for PostgreSQL
```

## üîí Security Configuration

### SSL/TLS Setup
```bash
# Railway automatically provides SSL
# For custom domains, configure DNS:
# CNAME: your-domain.com -> your-app.railway.app

# Force HTTPS redirects
# Configure in application or reverse proxy
```

### Security Headers
```python
# FastAPI security middleware
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

app.add_middleware(HTTPSRedirectMiddleware)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://your-frontend-domain.com"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## üìã Deployment Checklist

### Pre-deployment
- [ ] All tests passing
- [ ] Environment variables configured
- [ ] Database migrations ready
- [ ] SSL certificates configured
- [ ] Monitoring setup complete
- [ ] Backup strategy implemented

### Post-deployment
- [ ] Health checks passing
- [ ] Database connectivity verified
- [ ] Authentication working
- [ ] File uploads functional
- [ ] Email notifications working
- [ ] n8n workflows active
- [ ] Performance monitoring active
- [ ] Error tracking configured

## üêõ Troubleshooting

### Common Deployment Issues

#### Database Connection Errors
```bash
# Check database URL
railway variables get DATABASE_URL

# Test connection
psql $DATABASE_URL -c "SELECT version();"

# Check firewall rules
# Ensure database accepts connections from app servers
```

#### CORS Errors
```bash
# Verify CORS origins
railway variables get BACKEND_CORS_ORIGINS

# Update CORS settings
railway variables set BACKEND_CORS_ORIGINS='["https://your-frontend.railway.app"]'
```

#### Build Failures
```bash
# Check build logs
railway logs --service api

# Clear build cache
railway redeploy --service api

# Verify dependencies
# Check requirements.txt and package.json
```

#### Performance Issues
```bash
# Monitor resource usage
railway metrics

# Scale services
railway scale --service api --replicas 3

# Optimize database queries
# Add indexes for frequently queried columns
```

## üìû Support

### Deployment Support
- **Railway Support**: https://railway.app/help
- **Render Support**: https://render.com/docs
- **Platform.sh Support**: https://platform.sh/support

### Project Support
- **GitHub Issues**: [Project Issues](https://github.com/KNIGHTPROJEKS-0/MSWD-Livelihood-Rizal-Palawan-Web-App/issues)
- **Email**: knightprojeks@gmail.com
- **Documentation**: Check existing docs and guides

---

**Last Updated**: January 2025  
**Deployment Status**: ‚úÖ Production Ready